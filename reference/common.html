

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Common &mdash; Ptychography 4.0 0.2.0.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=130a53a1"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="../changelog.html" />
    <link rel="prev" title="Stitching" href="stitching.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Ptychography 4.0
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Public datasets</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ssb.html">Single Side Band</a></li>
<li class="toctree-l2"><a class="reference internal" href="stitching.html">Stitching</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Common</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.apply_matrix"><code class="docutils literal notranslate"><span class="pre">apply_matrix()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.diffraction_to_detector"><code class="docutils literal notranslate"><span class="pre">diffraction_to_detector()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.fftshift_coords"><code class="docutils literal notranslate"><span class="pre">fftshift_coords()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.get_shifted"><code class="docutils literal notranslate"><span class="pre">get_shifted()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.ifftshift_coords"><code class="docutils literal notranslate"><span class="pre">ifftshift_coords()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix"><code class="docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.rolled_object_aggregation_cpu"><code class="docutils literal notranslate"><span class="pre">rolled_object_aggregation_cpu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.rolled_object_aggregation_cuda"><code class="docutils literal notranslate"><span class="pre">rolled_object_aggregation_cuda()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.rolled_object_probe_product_cpu"><code class="docutils literal notranslate"><span class="pre">rolled_object_probe_product_cpu()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.rolled_object_probe_product_cuda"><code class="docutils literal notranslate"><span class="pre">rolled_object_probe_product_cuda()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.shifted_probes"><code class="docutils literal notranslate"><span class="pre">shifted_probes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#ptychography40.reconstruction.common.wavelength"><code class="docutils literal notranslate"><span class="pre">wavelength()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releasing.html">Releasing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ptychography 4.0</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Reference</a></li>
      <li class="breadcrumb-item active">Common</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/reference/common.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-ptychography40.reconstruction.common">
<span id="common"></span><h1>Common<a class="headerlink" href="#module-ptychography40.reconstruction.common" title="Link to this heading"></a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.apply_matrix">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">apply_matrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sources</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_shape</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#apply_matrix"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.apply_matrix" title="Link to this definition"></a></dt>
<dd><p>Apply a transformation matrix generated by <a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a> to
a stack of images.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>sources</strong> (<em>array-like</em>) – Array of shape (n, sy, sx) where (sy, sx) is the <code class="code docutils literal notranslate"><span class="pre">source_shape</span></code> parameter
of <a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a>.</p></li>
<li><p><strong>matrix</strong> (<em>array-like</em>) – Matrix generated by <a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a> or equivalent</p></li>
<li><p><strong>target_shape</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – <code class="code docutils literal notranslate"><span class="pre">source_shape</span></code> parameter of <a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a>.
The result will be reshaped to <code class="code docutils literal notranslate"><span class="pre">(n,</span> <span class="pre">)</span> <span class="pre">+</span> <span class="pre">target_shape</span></code></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.diffraction_to_detector">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">diffraction_to_detector</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">lamb</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">diffraction_shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pixel_size_real</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pixel_size_detector</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cx</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flip_y</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scan_rotation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#diffraction_to_detector"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.diffraction_to_detector" title="Link to this definition"></a></dt>
<dd><p>Generate a function that transforms pixel coordinates from diffraction of
real space to detector coordinates.</p>
<p>When performing a forward calculation where a wave front is passed through an object
function and projected in the far field, the projection is a Fourier transform.
Each pixel in the fourier-transformed slice of real space corresponds to a diffraction
angle in radian. This angle is a function of real space dimensions and wavelength.</p>
<p>For ptychography, this forward-projected beam is put in relation with detector data.
The projection and detector, however, are usually not calibrated in such a way that each
pixel corresponds exactly to one diffracted pixel/beam from the object and illumination
function. This function applies the correct scale, rotation and handedness to match
the forward-projected beam with the detector data, given the necessary input parameters.</p>
<p>cy, cx, flip_y and scan_rotation are chosen to correspond to the parameters in
:meth:libertem.api.Context.create_com_analysis`.</p>
<p>This function is designed to create a <code class="code docutils literal notranslate"><span class="pre">affine_transformation</span></code> parameter
for <a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>lamb</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a>) – Wavelength in m</p></li>
<li><p><strong>diffraction_shape</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – Shape of the diffracted area</p></li>
<li><p><strong>pixel_size_real</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3.12/library/stdtypes.html#tuple" title="(in Python v3.12)"><em>tuple</em></a><em> or </em><em>ndarray</em>) – Pixel size in m for the diffracted shape. Can be a Tuple[float, float] or array with
two values for y and x</p></li>
<li><p><strong>pixel_size_detector</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3.12/library/stdtypes.html#tuple" title="(in Python v3.12)"><em>tuple</em></a><em> or </em><em>ndarray</em>) – Pixel size in radian of the detector. Can be a Tuple[float, float] or array with two values
for y and x. For free propagation into the far-field, this is the detector pixel size in
m divided by the camera length for small angles.</p></li>
<li><p><strong>cy</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a>) – Y position of the central beam on the detector in pixel.</p></li>
<li><p><strong>cx</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a>) – X position of the central beam on the detector in pixel.</p></li>
<li><p><strong>flip_y</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#bool" title="(in Python v3.12)"><em>bool</em></a>) – Flip the y axis of the detector coordinates</p></li>
<li><p><strong>scan_rotation</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a>) – Scan rotation in degrees</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>transform</strong> – A function that accepts pixel coordinates in diffracted space as an
array of shape (n, 2) with (y, x). Upper left
corner is (0, 0). It returns pixel coordinates on the detector as floats of shape (n, 2).</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>callable(coords : numpy.ndarray) -&gt; numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.fftshift_coords">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">fftshift_coords</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">reconstruct_shape</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#fftshift_coords"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.fftshift_coords" title="Link to this definition"></a></dt>
<dd><p>Generate a function that performs an FFT shift of coordinates.</p>
<p>On the detector, the central beam is near the center, while for native FFT
the center is at the (0, 0) position of the result array. Instead of
fft-shifting the result of a projection calculation to match the detector directly,
one can instead calculate a transformation that picks from an unshifted FFT result
in such a way that it matches a diffraction pattern in its native layout. This allows
to combine the FFT shift with additional transformation steps. See also
<a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>reconstruct_shape</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – Taget shape</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Callable(coords</strong> – Function that accepts target coordinates with shape (n, 2), kind int
and calculates the source coordinates with shape (n, 2), kind int
so that taking from the source coordinates and placing into the target
coordinates performs an FFT shift.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)">numpy.ndarray</a>)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.get_shifted">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">get_shifted</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">arr_shape</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3.12/library/stdtypes.html#tuple" title="(in Python v3.12)"><span class="pre">tuple</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_origin</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3.12/library/stdtypes.html#tuple" title="(in Python v3.12)"><span class="pre">tuple</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">tile_shape</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3.12/library/stdtypes.html#tuple" title="(in Python v3.12)"><span class="pre">tuple</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">shift</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3.12/library/stdtypes.html#tuple" title="(in Python v3.12)"><span class="pre">tuple</span></a></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#get_shifted"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.get_shifted" title="Link to this definition"></a></dt>
<dd><p>Calculate the slices to cut out a shifted part of a 2D source
array and place it into a target array, including tiling support.</p>
<p>This works with negative and positive integer shifts.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.ifftshift_coords">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">ifftshift_coords</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">reconstruct_shape</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#ifftshift_coords"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.ifftshift_coords" title="Link to this definition"></a></dt>
<dd><p>Generate a function that performs an inverse FFT shift of coordinates.</p>
<p>On the detector, the central beam is near the center, while for native FFT
the center is at the (0, 0) position of the result array. Instead of
fft-shifting the result of a projection calculation to match the detector,
one can instead calculate a transformation that picks from the detector data
in such a way that an inverse FFT shift is performed. This allows to combine the
inverse FFT shift with additional transformations. See also
<a class="reference internal" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="ptychography40.reconstruction.common.image_transformation_matrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_transformation_matrix()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>reconstruct_shape</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – Taget shape</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Callable(coords</strong> – Function that accepts target coordinates with shape (n, 2), kind int
and calculates the source coordinates with shape (n, 2), kind int
so that taking from the source coordinates and placing into the target
coordinates performs an inverse FFT shift.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)">numpy.ndarray</a>)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.image_transformation_matrix">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">image_transformation_matrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">source_shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_shape</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">affine_transformation</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre_transform</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">post_transform</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#image_transformation_matrix"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.image_transformation_matrix" title="Link to this definition"></a></dt>
<dd><p>Construct a sparse matrix that transforms a flattened source image stack to
a flattened target image stack.</p>
<p>A sparse matrix prodct can be a highly efficient method to apply a set of
transformations to an image in one pass. This function constructs a sparse
matrix that picks values from a source image to fill each pixel of the
target image by first applying <code class="code docutils literal notranslate"><span class="pre">pre_transform()</span></code> to the target image
indices to map them into a 2D vector space, then projecting the pixel
outline in this vector space using <code class="code docutils literal notranslate"><span class="pre">affine_transformation()</span></code> to
calculate the source pixel coordinates, and then using
<code class="code docutils literal notranslate"><span class="pre">post_transform()</span></code> to map the source coordinates to indices in the
source image. If the projected pixel is of size 1.5 or smaller in the source
coordinates, the closest integer is chosen. If it is larger, the average of
pixels within the projected pixel outline is chosen. This corresponds to
scaling with order=0 in <code class="xref py py-meth docutils literal notranslate"><span class="pre">scipy.ndimage.zoom()</span></code>.</p>
<p><code class="code docutils literal notranslate"><span class="pre">pre_transform()</span> <span class="pre">and</span> <span class="pre">:code:`post_transform()</span></code> can also be used for
shifting the center of <code class="code docutils literal notranslate"><span class="pre">affine_transformation()</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>source_shape</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – Shape of source and target image for bounds checking and index raveling</p></li>
<li><p><strong>target_shape</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – Shape of source and target image for bounds checking and index raveling</p></li>
<li><p><strong>affine_transformation</strong> (<em>callable</em><em>(</em><em>coords -&gt; coords</em><em>)</em>) – Transformation that maps intermediate coordinates, i.e. the result of
applying <code class="code docutils literal notranslate"><span class="pre">pre_transform()</span></code>, to float source coordinates.
It should be continuous, strictly monotone and approximately affine for the size
of one pixel. <a class="reference internal" href="#ptychography40.reconstruction.common.diffraction_to_detector" title="ptychography40.reconstruction.common.diffraction_to_detector"><code class="xref py py-meth docutils literal notranslate"><span class="pre">diffraction_to_detector()</span></code></a> can be used to generate a suitable
coordinate transformation function.</p></li>
<li><p><strong>pre_transform</strong> (<em>callable</em><em>(</em><em>coords</em><em>) </em><em>-&gt; coords</em>) – Map target image indices to coordinates, typically euclidean. <code class="code docutils literal notranslate"><span class="pre">pre_transform()</span></code>
should not change the scale of the coordinates. It is designed to be something like
<a class="reference internal" href="#ptychography40.reconstruction.common.ifftshift_coords" title="ptychography40.reconstruction.common.ifftshift_coords"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ifftshift_coords()</span></code></a> to un-scramble target coordinates so that coordinates that
are close in the source image are also close in the
un-scrambled intermediate coordinates generated by this function.
This is identity by default.</p></li>
<li><p><strong>post_transform</strong> (<em>callable</em><em>(</em><em>coords</em><em>) </em><em>-&gt; coords</em><em>(</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>)</em>) – Map source image coordinates, typically euclidean, to source image indices.
<code class="code docutils literal notranslate"><span class="pre">post_transform()</span></code> should not change the scale of the coordinates. By default it
is <code class="code docutils literal notranslate"><span class="pre">np.round(...).astype(int)</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Shape np.prod(source_shape), np.prod(target_shape)</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>scipy.sparse.csc_matrix</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.rolled_object_aggregation_cpu">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">rolled_object_aggregation_cpu</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj_out</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">updates</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shifts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fftshift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#rolled_object_aggregation_cpu"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.rolled_object_aggregation_cpu" title="Link to this definition"></a></dt>
<dd><p>Aggregate shifted updates to an object function</p>
<p>This function accumulates updates that are shifted relative to the object function
using addition and rolls the indices within the object if necesssary.
Optionally, it can fftshift the updates while integrating. Doing this in one loop allows to
reduce the number of calls for each shift and reduces overall memory transfer.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>obj_out</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – 2D array with the object, modified in-place by this function</p></li>
<li><p><strong>updates</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – Array with updates, shape (n, …)</p></li>
<li><p><strong>shifts</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – Array with shift vectors, shape (n, 2), kind int</p></li>
<li><p><strong>fftshift</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#bool" title="(in Python v3.12)"><em>bool</em></a>) – Read the updates fft-shifted from <code class="code docutils literal notranslate"><span class="pre">updates</span></code></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.rolled_object_aggregation_cuda">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">rolled_object_aggregation_cuda</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj_out</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">updates</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shifts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fftshift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#rolled_object_aggregation_cuda"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.rolled_object_aggregation_cuda" title="Link to this definition"></a></dt>
<dd><p>Numba CUDA version of <a class="reference internal" href="#ptychography40.reconstruction.common.rolled_object_aggregation_cpu" title="ptychography40.reconstruction.common.rolled_object_aggregation_cpu"><code class="xref py py-meth docutils literal notranslate"><span class="pre">rolled_object_aggregation_cpu()</span></code></a></p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.rolled_object_probe_product_cpu">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">rolled_object_probe_product_cpu</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shifts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">result_out</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ifftshift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#rolled_object_probe_product_cpu"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.rolled_object_probe_product_cpu" title="Link to this definition"></a></dt>
<dd><p>Multiply object and shifted illumination</p>
<p>This function combines several steps that are relevant for ptychographic reconstruction:</p>
<ul class="simple">
<li><p>Multiply an object function with a shifted illumination</p></li>
<li><p>Roll the object function indices around the edges</p></li>
<li><p>Optionally, perform an ifftshift to prepare the data for subsequent FFT</p></li>
</ul>
<p>These steps are combined in a single loop since each requires significant memory
transfer if they are performed step-by-step. For performance reasons it doesn’t perform a
free subpixel shift, but picks the best option from a set of pre-calculated shifted versions.</p>
<p>See <a class="reference internal" href="#ptychography40.reconstruction.common.shifted_probes" title="ptychography40.reconstruction.common.shifted_probes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">shifted_probes()</span></code></a> for a function to calculate the shifted versions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>obj</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – 2D array with the object</p></li>
<li><p><strong>probe</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – 4D array with subpixel shifts of the probe, last two dimensions same size or
smaller than obj.</p></li>
<li><p><strong>shifts</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – Array with shift vectors, shape (n, 2), kind float</p></li>
<li><p><strong>result_out</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – Array where the result is placed. Shape (n, ) + probe.shape</p></li>
<li><p><strong>ifftshift</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#bool" title="(in Python v3.12)"><em>bool</em></a>) – place the product ifft-shifted into <code class="code docutils literal notranslate"><span class="pre">result_out</span></code></p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>subpixel_indices</strong> – The first two indices for <code class="code docutils literal notranslate"><span class="pre">probe</span></code></p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>np.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.rolled_object_probe_product_cuda">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">rolled_object_probe_product_cuda</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">shifts</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">result_out</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ifftshift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#rolled_object_probe_product_cuda"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.rolled_object_probe_product_cuda" title="Link to this definition"></a></dt>
<dd><p>Numba CUDA version of <a class="reference internal" href="#ptychography40.reconstruction.common.rolled_object_probe_product_cpu" title="ptychography40.reconstruction.common.rolled_object_probe_product_cpu"><code class="xref py py-meth docutils literal notranslate"><span class="pre">rolled_object_probe_product_cpu()</span></code></a></p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.shifted_probes">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">shifted_probes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">probe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bins</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#shifted_probes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.shifted_probes" title="Link to this definition"></a></dt>
<dd><p>Calculated subpixel-shifted versions of the probe</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>probe</strong> (<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)"><em>numpy.ndarray</em></a>) – </p></li>
<li><p><strong>bins</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em> or </em><em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#int" title="(in Python v3.12)"><em>int</em></a><em>]</em>) – Number of antialiasing steps in y and x axis. Can be int as well</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>probes</strong> – 4D, shape bins + probe.shape or (bins, bins) + probe.shape if bins is an int</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v2.3)">numpy.ndarray</a></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="ptychography40.reconstruction.common.wavelength">
<span class="sig-prename descclassname"><span class="pre">ptychography40.reconstruction.common.</span></span><span class="sig-name descname"><span class="pre">wavelength</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">U</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/ptychography40/reconstruction/common.html#wavelength"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#ptychography40.reconstruction.common.wavelength" title="Link to this definition"></a></dt>
<dd><p>Calculate the electron wavelength</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>U</strong> (<a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)"><em>float</em></a>) – Acceleration voltage in kV</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>wavelength</strong> – Wavelength in m</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.12/library/functions.html#float" title="(in Python v3.12)">float</a></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wavelength</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  
<span class="go">1.9687...e-12</span>
</pre></div>
</div>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="stitching.html" class="btn btn-neutral float-left" title="Stitching" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2020, Ptychography 4.0 Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>